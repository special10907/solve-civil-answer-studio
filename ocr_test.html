<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>OCR ì§„ë‹¨ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: monospace;
        background: #0f172a;
        color: #e2e8f0;
        padding: 20px;
      }
      h1 {
        color: #38bdf8;
      }
      .log {
        background: #1e293b;
        border-radius: 8px;
        padding: 16px;
        margin: 8px 0;
      }
      .ok {
        color: #4ade80;
      }
      .err {
        color: #f87171;
      }
      .warn {
        color: #facc15;
      }
      .info {
        color: #93c5fd;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 4px;
        font-size: 14px;
      }
      button:hover {
        background: #2563eb;
      }
      #output {
        white-space: pre-wrap;
        max-height: 600px;
        overflow-y: auto;
      }
      progress {
        width: 100%;
        height: 20px;
        margin: 8px 0;
      }
      canvas {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”¬ Tesseract.js OCR ì§„ë‹¨ ë„êµ¬</h1>
    <p class="info">
      ì´ í˜ì´ì§€ëŠ” OCR ê¸°ëŠ¥ë§Œ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. <b>ì½˜ì†”(F12)</b>ë„ í•¨ê»˜
      í™•ì¸í•˜ì„¸ìš”.
    </p>

    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin: 16px 0">
      <button onclick="testTesseractLoaded()">1. Tesseract ë¡œë“œ í™•ì¸</button>
      <button onclick="testWorkerCreate()">2. ì›Œì»¤ ìƒì„± í…ŒìŠ¤íŠ¸</button>
      <button onclick="testWorkerOcrCanvas()">3. ìº”ë²„ìŠ¤ OCR í…ŒìŠ¤íŠ¸</button>
      <button onclick="clearOutput()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <input
      type="file"
      id="pdfInput"
      accept=".pdf"
      style="display: none"
      onchange="testOcrOnPdf()"
    />
    <button onclick="document.getElementById('pdfInput').click()">
      4. PDF íŒŒì¼ë¡œ OCR í…ŒìŠ¤íŠ¸
    </button>

    <div class="log">
      <div id="output">ì—¬ê¸°ì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤...\n</div>
    </div>

    <canvas id="testCanvas"></canvas>

    <!-- Tesseract.js v5 (ë¡œì»¬ ë³µì‚¬ë³¸ ì‚¬ìš©) -->
    <script src="vendor/js/tesseract.min.js"></script>
    <!-- PDF.js -->
    <script src="vendor/js/pdf.min.js"></script>

    <script>
      const TESS_VERSION = "5.1.1";
      const TESS_WORKER_PATH = `https://cdn.jsdelivr.net/npm/tesseract.js@v${TESS_VERSION}/dist/worker.min.js`;
      const TESS_LANG_PATH = "https://tessdata.projectnaptha.com/4.0.0";

      function log(msg, type = "info") {
        const el = document.getElementById("output");
        const ts = new Date().toLocaleTimeString();
        el.innerHTML += `<span class="${type}">[${ts}] ${msg}</span>\n`;
        el.scrollTop = el.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${msg}`);
      }

      function clearOutput() {
        document.getElementById("output").innerHTML = "";
      }

      function testTesseractLoaded() {
        log("=== Tesseract ë¡œë“œ ìƒíƒœ í™•ì¸ ===", "info");
        if (typeof window.Tesseract === "undefined") {
          log(
            "âŒ window.Tesseractê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ - tesseract.min.js ë¡œë“œ ì‹¤íŒ¨!",
            "err",
          );
          return;
        }
        log(`âœ… window.Tesseract íƒ€ì…: ${typeof window.Tesseract}`, "ok");
        log(
          `âœ… Tesseract ì†ì„±: ${Object.keys(window.Tesseract).join(", ")}`,
          "ok",
        );
        log(
          `âœ… createWorker í•¨ìˆ˜ ì¡´ì¬: ${typeof window.Tesseract.createWorker}`,
          "ok",
        );
        log(
          `âœ… recognize í•¨ìˆ˜ ì¡´ì¬: ${typeof window.Tesseract.recognize}`,
          "ok",
        );
        // í”„ë¡œí† ì½œ í™•ì¸
        log(
          `â„¹ï¸ í˜„ì¬ í”„ë¡œí† ì½œ: ${location.protocol}`,
          location.protocol === "file:" ? "warn" : "ok",
        );
        log(`â„¹ï¸ í˜„ì¬ URL: ${location.href}`, "info");
      }

      async function testWorkerCreate() {
        log("=== Tesseract ì›Œì»¤ ìƒì„± í…ŒìŠ¤íŠ¸ ===", "info");
        if (!window.Tesseract) {
          log("âŒ Tesseract ë¯¸ë¡œë“œ", "err");
          return;
        }

        const workerOpts = {
          workerBlobURL: false,
          workerPath: TESS_WORKER_PATH,
          langPath: TESS_LANG_PATH,
          logger: (m) => {
            if (m && m.status) {
              log(
                `  [ì§„í–‰] ${m.status}: ${m.progress != null ? Math.round(m.progress * 100) + "%" : ""}`,
                "info",
              );
            }
          },
          errorHandler: (err) => log(`  [ì—ëŸ¬] ${err}`, "err"),
        };

        // 1ë‹¨ê³„: engë§Œ ì‹œë„
        log("kor+eng ì›Œì»¤ ìƒì„± ì‹œë„...", "warn");
        try {
          const w = await window.Tesseract.createWorker(
            "kor+eng",
            1,
            workerOpts,
          );
          log("âœ… kor+eng ì›Œì»¤ ìƒì„± ì„±ê³µ!", "ok");
          await w.terminate();
          log("âœ… ì›Œì»¤ ì¢…ë£Œ ì™„ë£Œ.", "ok");
        } catch (e) {
          log(`âŒ kor+eng ì›Œì»¤ ìƒì„± ì‹¤íŒ¨: ${(e && e.message) || e}`, "err");
          log("eng ë‹¨ë…ìœ¼ë¡œ ì¬ì‹œë„...", "warn");
          try {
            const w2 = await window.Tesseract.createWorker(
              "eng",
              1,
              workerOpts,
            );
            log("âœ… eng ì›Œì»¤ ìƒì„± ì„±ê³µ!", "ok");
            await w2.terminate();
          } catch (e2) {
            log(`âŒ eng ì›Œì»¤ë„ ì‹¤íŒ¨: ${(e2 && e2.message) || e2}`, "err");
            log(
              "ğŸ’¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” CDN ì ‘ê·¼ ë¶ˆê°€ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
              "warn",
            );
          }
        }
      }

      async function testWorkerOcrCanvas() {
        log("=== ìº”ë²„ìŠ¤ ê¸°ë°˜ OCR í…ŒìŠ¤íŠ¸ ===", "info");
        if (!window.Tesseract) {
          log("âŒ Tesseract ë¯¸ë¡œë“œ", "err");
          return;
        }

        // í…ŒìŠ¤íŠ¸ìš© ìº”ë²„ìŠ¤ ìƒì„± (ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¼)
        const canvas = document.getElementById("testCanvas");
        canvas.width = 400;
        canvas.height = 100;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, 400, 100);
        ctx.fillStyle = "black";
        ctx.font = "30px Arial";
        ctx.fillText("Hello OCR Test 123", 20, 60);

        log(
          "í…ŒìŠ¤íŠ¸ ìº”ë²„ìŠ¤ ìƒì„± ì™„ë£Œ (í° ë°°ê²½ì— 'Hello OCR Test 123' í…ìŠ¤íŠ¸)",
          "info",
        );

        const workerOpts = {
          workerBlobURL: false,
          workerPath: TESS_WORKER_PATH,
          langPath: TESS_LANG_PATH,
          logger: (m) => {
            if (m && m.status)
              log(
                `  [ì§„í–‰] ${m.status}: ${m.progress != null ? Math.round(m.progress * 100) + "%" : ""}`,
                "info",
              );
          },
        };

        try {
          log("eng ì›Œì»¤ë¡œ ìº”ë²„ìŠ¤ OCR ì¸ì‹ ì¤‘...", "warn");
          const result = await window.Tesseract.recognize(
            canvas,
            "eng",
            workerOpts,
          );
          const text = (result?.data?.text || "").trim();
          log(`âœ… OCR ì¸ì‹ ê²°ê³¼: "${text}"`, text ? "ok" : "warn");
          if (text.includes("Hello") || text.includes("123")) {
            log("âœ… í…ìŠ¤íŠ¸ ì¸ì‹ ì„±ê³µ! OCR ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.", "ok");
          } else {
            log(
              "âš ï¸ ì˜ˆìƒ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸ì‹ í’ˆì§ˆì„ í™•ì¸í•˜ì„¸ìš”.",
              "warn",
            );
          }
        } catch (e) {
          log(`âŒ OCR ì¸ì‹ ì‹¤íŒ¨: ${(e && e.message) || e}`, "err");
        }
      }

      async function testOcrOnPdf() {
        log("=== PDF íŒŒì¼ OCR í…ŒìŠ¤íŠ¸ ===", "info");
        const input = document.getElementById("pdfInput");
        const file = input.files[0];
        if (!file) {
          log("âŒ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ", "err");
          return;
        }
        log(`íŒŒì¼: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`, "info");

        if (!window.pdfjsLib) {
          log("âŒ pdf.js ë¯¸ë¡œë“œ", "err");
          return;
        }
        if (!window.Tesseract) {
          log("âŒ Tesseract ë¯¸ë¡œë“œ", "err");
          return;
        }

        try {
          // PDF.js ì„¤ì •
          window.pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.mjs";

          const buffer = await file.arrayBuffer();
          const pdf = await window.pdfjsLib.getDocument({ data: buffer })
            .promise;
          log(`âœ… PDF ë¡œë“œ ì™„ë£Œ: ${pdf.numPages}í˜ì´ì§€`, "ok");

          // 1í˜ì´ì§€ë§Œ í…ŒìŠ¤íŠ¸
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.getElementById("testCanvas");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext("2d");
          await page.render({ canvasContext: ctx, viewport }).promise;
          log("âœ… 1í˜ì´ì§€ ìº”ë²„ìŠ¤ ë Œë”ë§ ì™„ë£Œ", "ok");

          const workerOpts = {
            workerBlobURL: false,
            workerPath: TESS_WORKER_PATH,
            langPath: TESS_LANG_PATH,
            logger: (m) => {
              if (m && m.status)
                log(
                  `  [ì§„í–‰] ${m.status}: ${m.progress != null ? Math.round(m.progress * 100) + "%" : ""}`,
                  "info",
                );
            },
          };

          log("kor+eng OCR ì¸ì‹ ì‹œì‘...", "warn");
          const result = await window.Tesseract.recognize(
            canvas,
            "kor+eng",
            workerOpts,
          );
          const text = (result?.data?.text || "").trim();
          log(
            `âœ… OCR ê²°ê³¼ (ì²˜ìŒ 500ì):\n${text.slice(0, 500)}`,
            text ? "ok" : "warn",
          );
        } catch (e) {
          log(`âŒ PDF OCR ì‹¤íŒ¨: ${(e && e.message) || e}`, "err");
          console.error(e);
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒíƒœ í™•ì¸
      window.addEventListener("load", () => {
        log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.", "info");
        testTesseractLoaded();
      });
    </script>
  </body>
</html>
